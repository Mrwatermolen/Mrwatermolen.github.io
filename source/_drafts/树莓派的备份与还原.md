---
title: 树莓派的备份与还原
tags:
  - raspios
  - 备份
  - 还原
categories:
  - Linux
---



## 全卡备份

就是把当前的SD卡全部复制到另一张新的SD卡上。要求新卡的容量大于等于旧卡。（并不适用于我。。）

## 原卡备份

要求当前树莓派所占空间小于 SD 卡空间的 50%，就可以在树莓派内部直接生成镜像。否则要将备份的镜像生成到挂载的外置 SD 卡里面。

```shell
pi@raspberrypi:~ $ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       117G  4.4G  108G   4% /
devtmpfs        3.7G     0  3.7G   0% /dev
tmpfs           3.9G     0  3.9G   0% /dev/shm
tmpfs           1.6G  4.1M  1.6G   1% /run
tmpfs           5.0M  4.0K  5.0M   1% /run/lock
tmpfs           3.9G   12K  3.9G   1% /tmp
/dev/mmcblk0p1  253M   30M  223M  12% /boot
folder2ram      3.9G  217M  3.7G   6% /var/log
folder2ram      3.9G     0  3.9G   0% /var/tmp
folder2ram      3.9G  440K  3.9G   1% /var/lib/openmediavault/rrd
folder2ram      3.9G  2.5M  3.9G   1% /var/spool
folder2ram      3.9G   14M  3.9G   1% /var/lib/rrdcached
folder2ram      3.9G  4.0K  3.9G   1% /var/lib/monit
folder2ram      3.9G   32K  3.9G   1% /var/cache/samba
/dev/sdb1       3.6T  3.4T   89G  98% /home/pi/DiskShare
/dev/sda1       7.3T  3.4T  3.6T  49% /home/pi/share
tmpfs           782M   24K  782M   1% /run/user/1000
```

重点看`/dev/root  `和`/dev/mmcblk0p1`，分别对应root区和boot区。这两个分区就是我们要备份的。可以看到我的树莓派总空间使用不到4.7GB。

### 创建一个空白镜像

命令

```shell
sudo dd if=/dev/zero of=./DiskShare/raspberrypi.img bs=1M count=4700
```

>dd 可从标准输入或文件中读取数据，根据指定的格式来转换数据，再输出到文件、设备或标准输出。

**参数说明:**

- if=文件名：输入文件名，默认为标准输入。即指定源文件。
- ibs=bytes：一次读入bytes个字节，即指定一个块大小为bytes个字节。
  obs=bytes：一次输出bytes个字节，即指定一个块大小为bytes个字节。
  bs=bytes：同时设置读入/输出的块大小为bytes个字节。
- bs=bytes：同时设置读入/输出的块大小为bytes个字节。
- count=blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。

`/dev/zero`随意，不存在都行。`./DiskShare/raspberrypi.img `是你要创建的镜像的路径。

我创建的镜像大小为 4700 * 1MB，就是4.7GB。

### 分割创建好的镜像文件

首先要看一下树莓派的磁盘结构

```shell
sudo fdisk -l
```

找到树莓派所在的磁盘，其实通过之前的`df -h`命令可以看到boot分区在`/dev/mmcblk0p1`分区里，只要没有什么特殊设置，树莓派所在磁盘肯定有`/dev/mmcblk0p1`分区。

```
Disk /dev/mmcblk0: 119.08 GiB, 127865454592 bytes, 249737216 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x1c727076

Device         Boot  Start       End   Sectors   Size Id Type
/dev/mmcblk0p1        8192    532479    524288   256M  c W95 FAT32 (LBA)
/dev/mmcblk0p2      532480 249737215 249204736 118.8G 83 Linux
```

第一个分区为 boot 分区，采用 FAT32 格式，从第8192个扇区到第532479 个扇区；第二个分区采用 EXT4，由第532480个扇区到结尾。

```shell
pi@raspberrypi:~ $ sudo parted DiskShare/raspberrypi.img --script -- mklabel msdos
pi@raspberrypi:~ $ sudo parted DiskShare/raspberrypi.img --script -- mkpart primary fat32 8192s 532479s
pi@raspberrypi:~ $ sudo parted DiskShare/raspberrypi.img --script -- mkpart primary ext4 532480s -1
```

-1表示到文件末尾。

检查是否成功

```shell
pi@raspberrypi:~ $ sudo parted DiskShare/raspberrypi.img
GNU Parted 3.4
Using /home/pi/DiskShare/raspberrypi.img
Welcome to GNU Parted! Type 'help' to view a list of commands.
```

输入`print free`

```shell
(parted) print free
Model:  (file)
Disk /home/pi/DiskShare/raspberrypi.img: 4928MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
        16.4kB  4194kB  4178kB           Free Space
 1      4194kB  273MB   268MB   primary               lba
 2      273MB   4927MB  4655MB  primary
        4927MB  4928MB  1049kB           Free Space

```

输入`quit`退出

### 挂载镜像并且格式化

```shell
pi@raspberrypi:~ $ sudo losetup -f --show DiskShare/raspberrypi.img
/dev/loop0
pi@raspberrypi:~ $ sudo kpartx -va /dev/loop0
add map loop0p1 (254:0): 0 524288 linear 7:0 8192
add map loop0p2 (254:1): 0 9091072 linear 7:0 532480
pi@raspberrypi:~ $ sudo kpartx -va /dev/loop0
add map loop0p1 (254:0): 0 524288 linear 7:0 8192
add map loop0p2 (254:1): 0 9091072 linear 7:0 532480
pi@raspberrypi:~ $ sudo mkfs.vfat -n boot /dev/mapper/loop0p1
mkfs.fat 4.2 (2021-01-31)
mkfs.fat: Warning: lowercase labels might not work properly on some systems
pi@raspberrypi:~ $ sudo mkfs.ext4 /dev/mapper/loop0p2
mke2fs 1.46.2 (28-Feb-2021)
Discarding device blocks: done
Creating filesystem with 1136384 4k blocks and 284480 inodes
Filesystem UUID: 61e42ea7-5e08-4a33-b3b4-d15ca604a8a0
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done
```



## 使用OMV插件backup备份

Failed to execute command 'export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin; export LANG=C.UTF-8; /usr/sbin/omv-backup 2>&1': No backup volume set.  Please choose a backup volume.

OMV\ExecException: Failed to execute command 'export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin; export LANG=C.UTF-8; /usr/sbin/omv-backup 2>&1': No backup volume set.  Please choose a backup volume. in /usr/share/openmediavault/engined/rpc/backup.inc:72
Stack trace:
#0 /usr/share/php/openmediavault/rpc/serviceabstract.inc(588): OMVRpcServiceBackup->{closure}('/tmp/bgstatusDO...', '/tmp/bgoutputOj...')
#1 /usr/share/openmediavault/engined/rpc/backup.inc(74): OMV\Rpc\ServiceAbstract->execBgProc(Object(Closure))
#2 [internal function]: OMVRpcServiceBackup->doBackup(NULL, Array)
#3 /usr/share/php/openmediavault/rpc/serviceabstract.inc(123): call_user_func_array(Array, Array)
#4 /usr/share/php/openmediavault/rpc/rpc.inc(86): OMV\Rpc\ServiceAbstract->callMethod('doBackup', NULL, Array)
#5 /usr/sbin/omv-engined(537): OMV\Rpc\Rpc::call('Backup', 'doBackup', NULL, Array, 1)
#6 {main}

### 安装backup插件

> openmediavault-backup 6.0

轻点一下就好

### 创建用于备份的文件夹

`存储器->共享文件夹->创建`

### 开始备份

安装完插件后应该可以看到导航

`系统->备份`

选择备份文件夹，方式我选择`dd`备份。

点击备份等待即可。

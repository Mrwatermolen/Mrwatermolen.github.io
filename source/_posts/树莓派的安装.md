---
title: 树莓派的安装
tags:
  - raspios
categories:
  - Linux
date: 2021-11-27 11:05:23
---


> 前言：树莓派不知道怎么的，很多服务都出问题了，虽然好像还能正常用，不过问题太大了，之前把树莓派当作主力机来使用的，装了太多冗余的东西了，直接重装，打算直接做nas了

## 前期准备

### pt相关

把deluge的种子全部转移铺种到tr上

备份tr

备份transmission-daemon：

数据目录位于(apt安装的)：

```
/var/lib/transmission-daemon/.config
```

复制一份

种子迁移：跳过校验，有时间再写

### 下载相关

备份aria2

备份aria2配置文件，以及service

我的配置文件位于用户目下的.aria2

 /etc/systemd/system/aria2.service

复制一份

### 局域网共享相关

smb备份

备份配置文件

配置文件位于：

```
/etc/samba
```

复制一份

### 脚本

python脚本备份

bash脚本备份

### 其余

crontab

flexget

latex

fstab

## 重装

### 镜像下载和系统启动：

2021-10-30-raspios-bullseye-arm64

才注意到Debian版本换成了bullseye，升级换代了。

使用rpi-imager写入sd卡

然后写入错误。。。错误：数据错误(循环冗余检查)

这张卡用了很久了，一扫描果然出了坏道。唉，先屏蔽了凑合着用。。。新的sd卡还要几天才能到。。。

屏蔽完了，测试了一下

```
 *** 开始测试第 1 圈，共 1 圈 ***

                 位置      当前速度      平均速度        余量  剩余时间
正在写入       540 MB     3.22 MB/s     3.21 MB/s    29871 MB  02:34:55

无法向文件 F:\HUT00001.BIN 写入数据！
```

根本不能往里面写数据。。。

含泪使用switch的128g的内存卡，先备份一波switch。TT

写入成功后，为开启ssh功能

在sd卡的/boot上创建空白文件SSH

树莓派在局域网上的域名为：raspberrypi

win终端：

```shell
$ ssh pi@raspberrypi
```

出现提示：

```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:gYQNYVM3QMmcVj+stdH+2cXxo1EuQAz3aoLaMywTcXQ.
Please contact your system administrator.
Add correct host key in C:\\Users\\FranZero/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in C:\\Users\\FranZero/.ssh/known_hosts:4
ECDSA host key for raspberrypi has changed and you have requested strict checking.
Host key verification failed.
```

用个文本编辑器把用户目录下的.ssh/known_hosts的文件改了，我用的vscode

```shell
$ code .\.ssh\known_hosts
```

树莓派我之前绑定了ip：192.168.1.6，在known_hosts把有关于树莓派的都删了。

```
ssh pi@raspberrypi
```

默认密码是：raspberry

### 挂载原来的硬盘

```shell
pi@raspberrypi:~ $ sudo df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/root       117G  3.0G  110G   3% /
devtmpfs        3.7G     0  3.7G   0% /dev
tmpfs           3.9G     0  3.9G   0% /dev/shm
tmpfs           1.6G  908K  1.6G   1% /run
tmpfs           5.0M  4.0K  5.0M   1% /run/lock
/dev/mmcblk0p1  253M   30M  223M  12% /boot
tmpfs           782M   24K  782M   1% /run/user/1000
/dev/sdb1       3.6T  3.4T   89G  98% /media/pi/84e82e54-9eb3-4645-9b5b-aa7347415905
/dev/sda1       7.3T  3.4T  3.6T  49% /media/pi/6cd86da0-3efc-41c4-adf8-34871490569c
```

先挂载磁盘

```shell
pi@raspberrypi:~ $ sudo mount /dev/sdb1 DiskShare/
pi@raspberrypi:~ $ cd DiskShare/
pi@raspberrypi:~/DiskShare $ ls
```

### 换源

树莓派上版本了，所以原来备份的buster版本的就不能用了。。

换成清华源

>Debian 镜像使用帮助

Debian 的软件源配置文件是 `/etc/apt/sources.list`。将系统自带的该文件做个备份，将该文件替换为下面内容，即可使用 TUNA 的软件源镜像。

如果遇到无法拉取 https 源的情况，请先使用 http 源并安装：

```shell
$ sudo apt install apt-transport-https ca-certificates
```

再使用 TUNA 的软件源镜像。

---

备份一下source.list再改

```shell
pi@raspberrypi:~ $ cp /etc/apt/sources.list ./
pi@raspberrypi:~ $ sudo nano /etc/apt/sources.list
# 把里面的内容换成

# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free

deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free

deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free
# deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free

```

更新一下：

```shell
pi@raspberrypi:~ $ sudo apt update && sudo apt upgrade
```

### 安装v2rayA

先装v2ray

v2rayA 提供的镜像脚本（推荐）:

```shell
curl -Ls https://mirrors.v2raya.org/go.sh | sudo bash
```

感觉有点满。。

安装后可以关掉服务，因为 v2rayA 不依赖于该 systemd 服务。

```shell
sudo systemctl disable v2ray --now ### Xray 需要替换服务为 xray
```

通过软件源安装v2rayA

添加公钥

```bash
wget -qO - https://apt.v2raya.mzz.pub/key/public-key.asc | sudo apt-key add -
```

添加 V2RayA 软件源

```bash
echo "deb https://apt.v2raya.mzz.pub/ v2raya main" | sudo tee /etc/apt/sources.list.d/v2raya.list
sudo apt update
```

安装 V2RayA

```bash
sudo apt install v2raya
```

启动 v2rayA / 设置 v2rayA 自动启动

启动：

```shell
sudo systemctl start v2raya.service
```

设置开机自动启动:

```shell
sudo systemctl enable v2raya.service
```

设置v2rayA

网页访问：http://raspberrypi:2017/

对于 Debian11 用户来说，iptables 已被弃用。使用 nftables 作为 iptables 的后端以进行适配：

```bash
update-alternatives --set iptables /usr/sbin/iptables-nft
update-alternatives --set ip6tables /usr/sbin/ip6tables-nft
update-alternatives --set arptables /usr/sbin/arptables-nft
update-alternatives --set ebtables /usr/sbin/ebtables-nft
```

如果你想切换回 legacy 版本：

```bash
update-alternatives --set iptables /usr/sbin/iptables-legacy
update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
update-alternatives --set arptables /usr/sbin/arptables-legacy
update-alternatives --set ebtables /usr/sbin/ebtables-legacy
```

切换后重启即可。

设置一下暂时代理：

```shell
pi@raspberrypi:~ $ export http_proxy=http://127.0.0.1:20172
pi@raspberrypi:~ $ export https_proxy=http://127.0.0.1:20172
```

### 安装smb

```shell
pi@raspberrypi:~ $ sudo apt install samba
```

还原配置

```
pi@raspberrypi:~ $ sudo cp DiskShare/smb.conf /etc/samba/
```

添加用户

```shell
pi@raspberrypi:~ $ sudo smbpasswd -a pi
```

```shell
pi@raspberrypi:~ $ sudo systemctl reload smbd.service
```

### 安装transmission

```shell
pi@raspberrypi:~ $ sudo apt install transmission-daemon
```

先检查一下版本。。。（我备份的是2.94）

```shell
pi@raspberrypi:/var/lib/transmission-daemon/.config $ transmission-daemon  -V
transmission-daemon 3.00 (bb6b5a062e)
```

。。。居然变成了3.00，还好升级兼容数据。。。

还原tr

先停止服务

```
pi@raspberrypi:~ $ sudo systemctl stop transmission-daemon.service
```

还原数据

```shell
pi@raspberrypi:~ $ sudo cp -r DiskShare/.config/ /var/lib/transmission-daemon/
```

还原设置

```shell
pi@raspberrypi:~ $ sudo cp -r DiskShare/transmission-daemon/setting.json /etc/transmission-daemon/setting.json
```

重新启动

```shell
pi@raspberrypi:~ $ sudo systemctl restart transmission-daemon
pi@raspberrypi:~ $ sudo systemctl reload transmission-daemon
```

访问(如果你没有做特殊设置的话)：http://raspberrypi:9091/

美化，安装transmission-web-control：

```shell
wget https://github.com/ronggang/transmission-web-control/raw/master/release/install-tr-control-cn.sh
sudo bash install-tr-control-cn.sh
```

### 安装Aria2

```
 sudo apt install aria2
```

还原配置

```shell
mv DiskShare/aria2.service /etc/systemd/
mv DiskShare/.aria2/ ./
```

确认配置

```shell
pi@raspberrypi:~ $ cat .aria2/aria2.conf
## '#'开头为注释内容, 选项都有相应的注释说明, 根据需要修改 ##
## 被注释的选项填写的是默认值, 建议在需要修改时再取消注释  ##

## 文件保存相关 ##

# 文件的保存路径(可使用绝对路径或相对路径), 默认: 当前启动位置
dir=/home/pi/share/Aria2Download
# 启用磁盘缓存, 0为禁用缓存, 需1.16以上版本, 默认:16M
disk-cache=32M
# 文件预分配方式, 能有效降低磁盘碎片, 默认:prealloc
# 预分配所需时间: none < falloc ? trunc < prealloc
# falloc和trunc则需要文件系统和内核支持
# NTFS建议使用falloc, EXT3/4建议trunc, MAC 下需要注释此项
file-allocation=falloc
# 断点续传
continue=true

## 下载连接相关 ##

# 最大同时下载任务数, 运行时可修改, 默认:5
max-concurrent-downloads=5
# 同一服务器连接数, 添加时可指定, 默认:1
max-connection-per-server=5
# 最小文件分片大小, 添加时可指定, 取值范围1M -1024M, 默认:20M
# 假定size=10M, 文件为20MiB 则使用两个来源下载; 文件为15MiB 则使用一个来源下载
min-split-size=10M
# 单个任务最大线程数, 添加时可指定, 默认:5
split=5
# 整体下载速度限制, 运行时可修改, 默认:0
#max-overall-download-limit=0
# 单个任务下载速度限制, 默认:0
#max-download-limit=0
# 整体上传速度限制, 运行时可修改, 默认:0
#max-overall-upload-limit=0
# 单个任务上传速度限制, 默认:0
#max-upload-limit=0
# 禁用IPv6, 默认:false
disable-ipv6=true

## 进度保存相关 ##

# 从会话文件中读取下载任务
input-file=/home/pi/.aria2/aria2.session
# 在Aria2退出时保存`错误/未完成`的下载任务到会话文件
save-session=/home/pi/.aria2/aria2.session
# 定时保存会话, 0为退出时才保存, 需1.16.1以上版本, 默认:0
save-session-interval=60

## RPC相关设置 ##

# 启用RPC, 默认:false
enable-rpc=true
# 允许所有来源, 默认:false
rpc-allow-origin-all=true
# 允许非外部访问, 默认:false
rpc-listen-all=true
# 事件轮询方式, 取值:[epoll, kqueue, port, poll, select], 不同系统默认值不同
#event-poll=select
# RPC监听端口, 端口被占用时可以修改, 默认:6800
#rpc-listen-port=6800

## BT/PT下载相关 ##

# 当下载的是一个种子(以.torrent结尾)时, 自动开始BT任务, 默认:true
#follow-torrent=true
# BT监听端口, 当端口被屏蔽时使用, 默认:6881-6999
listen-port=51413
# 单个种子最大连接数, 默认:55
#bt-max-peers=55
# 打开DHT功能, PT需要禁用, 默认:true
enable-dht=false
# 打开IPv6 DHT功能, PT需要禁用
#enable-dht6=false
# DHT网络监听端口, 默认:6881-6999
#dht-listen-port=6881-6999
# 本地节点查找, PT需要禁用, 默认:false
#bt-enable-lpd=false
# 种子交换, PT需要禁用, 默认:true
enable-peer-exchange=false
# 每个种子限速, 对少种的PT很有用, 默认:50K
#bt-request-peer-speed-limit=50K
# 客户端伪装, PT需要
peer-id-prefix=-TR2770-
user-agent=Transmission/2.77
# 当种子的分享率达到这个数时, 自动停止做种, 0为一直做种, 默认:1.0
seed-ratio=0
# 强制保存会话, 话即使任务已经完成, 默认:false
# 较新的版本开启后会在任务完成后依然保留.aria2文件
#force-save=false
# BT校验相关, 默认:true
#bt-hash-check-seed=true
# 继续之前的BT任务时, 无需再次校验, 默认:false
bt-seed-unverified=true
# 保存磁力链接元数据为种子文件(.torrent文件), 默认:false
bt-save-metadata=true

pi@raspberrypi:~ $ cat /etc/systemd/system/aria2.service
[Unit]

Description=qBittorrent-nox

After=network.target



[Service]

User=root

Type=forking

RemainAfterExit=yes

ExecStart=/usr/bin/aria2c --conf-path="/home/pi/.aria2/aria2.conf" -D



[Install]

WantedBy=multi-user.target
```

启动

```shell
sudo systemctl start aria2.service
```

查看是否成功

```shell
sudo systemctl status aria2.service
```

设置开机启动

```
sudo systemctl enable aria2.service
```

### 安装proxychains

为了更好的配置代理，如果装了OMV，就不需要这个了

```shell
git clone https://github.com/rofl0r/proxychains-ng.git
cd proxychains-ng/
./configure --prefix=/usr --sysconfdir=/etc
sudo make && sudo make install
sudo make install-config
cd .. && rm -rf proxychains-ng
sudo nano /etc/proxychains.conf
```

拉到最后一行

改成：

```
socks5  127.0.0.1 20170
```

v2rayA是这么配置的。

### 安装Flexget

先更新一下pip3的源

```shell
pip3 install pip -U
pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

问题

```
 WARNING: The script calc-prorate is installed in '/home/pi/.local/bin' which is not on PATH.
  Consider adding this directory to PATH or, if you prefer to suppress this warning, use --no-warn-script-location.
```

环境变量没设置

解决

```
echo 'export PATH=/home/pi/.local/bin:$PATH' >>~/.bashrc
pi@raspberrypi:~ $ source ~/.bashrc
```

备份还原

```shell
mv DiskShare/.flexget/ ./
```

测试

```shell
pip3 install transmission-rpc #我配置文件写的是transmission
flexget --test execute
```

crontab还原

```shell
crontab -e
```

更多详见

https://wiki.ukenn.top/seedbox-wiki-1/untitled-1

### OMV安装

参考官网https://forum.openmediavault.org/index.php?thread/39490-install-omv6-on-debian-11-bullseye/

先添加源

```shell
nano add.sh #创建脚本
# 写入这些
cat <<EOF >> /etc/apt/sources.list.d/openmediavault.list
deb http://packages.openmediavault.org/public shaitan main
# deb http://downloads.sourceforge.net/project/openmediavault/packages shaitan main
## Uncomment the following line to add software from the proposed repository.
# deb http://packages.openmediavault.org/public shaitan-proposed main
# deb http://downloads.sourceforge.net/project/openmediavault/packages shaitan-proposed main
## This software is not part of OpenMediaVault, but is offered by third-party
## developers as a service to OpenMediaVault users.
# deb http://packages.openmediavault.org/public shaitan partner
# deb http://downloads.sourceforge.net/project/openmediavault/packages shaitan partner
EOF

# 添加开始
chmod +x add.sh 
sudo ./add.sh
```

再执行安装

```shell
nano install-omv.sh #创建脚本
# 写入这些
export LANG=C.UTF-8
export DEBIAN_FRONTEND=noninteractive
export APT_LISTCHANGES_FRONTEND=none
apt-get install --yes gnupg
wget -O "/etc/apt/trusted.gpg.d/openmediavault-archive-keyring.asc" https://packages.openmediavault.org/public/archive.key
apt-key add "/etc/apt/trusted.gpg.d/openmediavault-archive-keyring.asc"
apt-get update
apt-get --yes --auto-remove --show-upgraded \
    --allow-downgrades --allow-change-held-packages \
    --no-install-recommends \
    --option DPkg::Options::="--force-confdef" \
    --option DPkg::Options::="--force-confold" \
    install openmediavault-keyring openmediavault

# Populate the database.
omv-confdbadm populate

# Display the login information.
cat /etc/issue

# 安装开始
chmod +x install-omv.sh
sudo ./install-omv.sh
```

安装结束

```
To manage the system visit the openmediavault web control panel:

eth0: 192.168.1.6
eth0: fe80::9d86:6e7:5e02:45b9

By default the web control panel administrator account has the
username 'admin' and password 'openmediavault'.
It is recommended that you change the password for this account
within the web control panel or using the 'omv-firstaid' CLI
command.

For more information regarding this appliance, please visit the
web site: https://www.openmediavault.org
```

注意：由于omv会接管大量debian底层的设置，比如smb直接被接管了，ssh也禁止出来root用户以外的用登陆

直接访问http://192.168.1.6/，注意：omv和nginx在没有做特处理前是冲突的

默认用户：openmediavault 默认密码：admin

安装OMV-Extra：

```shell
sudo wget -O - https://github.com/OpenMediaVault-Plugin-Developers/installScript/raw/master/install | sudo bash
```

新版本的OMV-Extra，装了点击进入时，会出现**显示软件错误点鼠标左键**的错误，先切换成英文界面进入，再换回中文界面即可。

#### OMV设置ssh登录

OpenMediaVault 修改了 SSH 的权限机制，只有在SSH 用户组中的用户才允许通过 ssh 登陆服务器。

用户管理->用户->用户组，勾上ssh



#### OMV设置smb共享

先把transmission停了。

存储器->文件系统->挂载，挂载磁盘

存储器->文件系统->共享文件夹->创建，注意相对路径那如果你是想访问根目录，就填入./

服务->SMB->共享->创建，在选择分享文件夹拿选择你刚刚创建的共享文件夹

服务->SMB->设置，勾选启动



#### OMV设置transmission

悲剧的事情来了，我原来tr挂的文件夹时/home/pi/DiskShare，现在OMV接管后磁盘都挂载在/srv/目录下了。命名格式：文件系统的默认挂载点名称被统一设置成了 `dev-disk-by-uuid-XXXX` 这种格式.

解决链接：https://it.ismy.fun/2021/04/02/omv-5-change-default-mountpoint-name/

修改挂载点名称可以编辑 `/etc/openmediavault/config.xml` 配置文件，找到里面的 `<fstab></fstab>`这对标签中的文件挂载点信息`<mntent></mntent>`：

```xml
<fstab>
      <mntent>
        <uuid>ed23096c-3982-4a61-8b3e-28517653adb0</uuid>
        <fsname>/dev/disk/by-uuid/95a27f78-b514-4aec-abf2-77e75be86e0e</fsname>
        <dir>/srv/dev-disk-by-uuid-4dc04a66-7390-4587-811f-d561bbe74990</dir>
        <type>ext4</type>
        <opts>defaults,nofail,user_xattr,usrjquota=aquota.user,grpjquota=aquota.group,jqfmt=vfsv0,acl</opts>
        <freq>0</freq>
        <passno>2</passno>
        <hidden>0</hidden>
      </mntent>
      <mntent>
    </fstab>
```

把其中的 `<dir>/srv/dev-disk-by-uuid-4dc04a66-7390-4587-811f-d561bbe74990</dir>` 改成希望使用的挂载点名称，比如 `<dir>/srv/disk1</dir>`

修改完成以后，执行命令：

```shell
$ sudo omv-salt deploy run fstab
```

这个命令会根据修改后的配置文件，生成新的 `/etc/fstab` 配置信息。

重启系统，检查是否修改成功。

先备份一份

一般会成功的

注意此时transmission没有权限去访问数据，要把transmission也添加到pi组里面即可：

用户管理->用户组->编辑->成员：勾选debian-transmission即可（也不一定）

错误信息：	No UA presents! (2)

### 其他

#### fstab开机挂载磁盘

废弃，已经被OMV接管



```shell
sudo nano /etc/fstab
# 后面加上
/dev/sda1       /home/pi/share  ext4    defaults        1       1
/dev/sdb1       /home/pi/DiskShare  ext4    defaults        1       1

sudo mount -a #测试
```
